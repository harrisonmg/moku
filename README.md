# moku
[![Rust](https://github.com/harrisonmg/moku/workflows/Rust/badge.svg)](https://github.com/harrisonmg/moku/actions)
[![Latest version](https://img.shields.io/crates/v/moku.svg)](https://crates.io/crates/moku)
[![Documentation](https://docs.rs/moku/badge.svg)](https://docs.rs/moku)
![License](https://img.shields.io/crates/l/moku.svg)

Moku is a Rust library for creating hierarchical state machines. While it's also useful for creating flat state machines, nested states are a first-class feature of moku.

## Features
- Autogeneration of boilerplate, including
    * A full state list
    * A state tree diagram
    * A state machine type
    * A state machine builder type
- Mutable access to active states from both outside and within the state machine
- Proc macros that emit useful compiler errors
- No dynamic memory allocation
- Minimal stack memory usage
- Logging of state machine actions through the Rust `log` API
- `no_std` support

## Shortcomings
Because moku generates a tree of sum types to represent the state machine, states must be `Sized` and do not support generic parameters.

## What is a hierarchical state machine?
A hierarchical state machine (HSM) is a type of finite state machine where states can be nested inside of other states. Common functionalities between substates, such as state entry and exit actions, can be grouped by implementing them for the superstate. Beyond the convenient programming implications of HSMs, they often provide a more logical way of modeling systems.

A classic HSM example is blinky, a state machine that - when enabled - blinks some LED on and off:
```text
┌─Enabled─────────────────┐    ┌─Disabled───┐
│                         ├───►│            │
│       ┌─LedOn───┐       │    │            │
│    ┌─►│         ├──┐    │◄───┤            │
│    │  └─────────┘  │    │    └────────────┘
│    │               │    │
│    │  ┌─LedOff──┐  │    │
│    └──┤         │◄─┘    │
│       └─────────┘       │
│                         │
└─────────────────────────┘
```

Blinky has two superstates: `Enabled` and `Disabled`. When in the `Enabled` state, it cycles between two substates, `LedOn` and `LedOff`, which results in a blinking LED when enabled.

## Usage
The simplest possible moku state machine can be defined as follows:
```rust

// The `state_machine` attribute indicates to moku that the `blinky` module contains
// state definitions and an empty module for it to generate the state machine within.
#[moku::state_machine]
mod blinky {
    // The `machine_module` attribute marks the module moku will use for autogeneration.
    #[moku::machine_module]
    mod state_machine {}

    // Moku has autogenerated `BlinkyState`, an enum of all states.
    use state_machine::BlinkyState;

    // Every moku state machine must have a single `TopState`, which acts as a
    // superstate to all other states. The state machine never leaves this state.
    struct Top;

    // The top state is indicated by implementing the `TopState` trait for a struct.
    impl moku::TopState<BlinkyState> for Top {}
}
```

Let's add some more states inside the `blinky` module:
```rust
# #[moku::state_machine]
# mod blinky {
#     #[moku::machine_module]
#     mod state_machine {}
#     use state_machine::BlinkyState;
#     struct Top;
#     impl moku::TopState<BlinkyState> for Top {}
#
    struct Disabled;

    // Every `State` must use the `superstate` attribute to indicate what state
    // it is a substate of.
    #[moku::superstate(Top)]
    impl moku::State<BlinkyState> for Disabled {}

    struct Enabled;

    #[moku::superstate(Top)]
    impl moku::State<BlinkyState> for Enabled {}

    struct LedOn;

    #[moku::superstate(Enabled)]
    impl moku::State<BlinkyState> for LedOn {}

    struct LedOff;

    #[moku::superstate(Enabled)]
    impl moku::State<BlinkyState> for LedOff {}
# }
```

## Warning
Moku exposes the [internal] module, the contents of which are intended to be used only by the code that is autogenerated by moku. This, in addition to the methods defined in the [TopState] and [State] traits, are not intended to be called by users.

## Macro expansion
Should you wish to view the fully expanded code generated by moku, the [cargo-expand](https://crates.io/crates/cargo-expand) crate may prove useful.
